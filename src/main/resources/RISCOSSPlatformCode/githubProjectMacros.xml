<?xml version='1.0' encoding='UTF-8'?>
<xwikidoc version="1.1">
  <web>RISCOSSPlatformCode</web>
  <name>githubProjectMacros</name>
  <language/>
  <defaultLanguage>en</defaultLanguage>
  <translation>0</translation>
  <creator>xwiki:XWiki.superadmin</creator>
  <creationDate>1436526896000</creationDate>
  <author>xwiki:XWiki.superadmin</author>
  <contentAuthor>xwiki:XWiki.superadmin</contentAuthor>
  <date>1438004077000</date>
  <contentUpdateDate>1438004072000</contentUpdateDate>
  <version>1.40</version>
  <title/>
  <comment/>
  <minorEdit>true</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity}}&#xd;
## This page contains the macros used the manage github projects&#xd;
&#xd;
## Calculate analysis score&#xd;
#macro(getProjectScore $analysisSessionDoc)&#xd;
   #set($asDoc = $analysisSessionDoc)&#xd;
   #set($riskEvaluation = $asDoc.getObject('RISCOSSPlatformRiskAnalysisManagerCode.RiskEvaluationClass'))&#xd;
   #if ("$!riskEvaluation.getProperty('score').value" != '')&#xd;
      #set($projectScore = $riskEvaluation.getProperty('score').getValue())&#xd;
      #set($projectScore = $mathtool.roundTo(4,$projectScore))&#xd;
   #else&#xd;
      #set($projectScore = 0)&#xd;
   #end&#xd;
#end   &#xd;
&#xd;
## Calculate analysis score&#xd;
#macro(getProjectScore2 $analysisSessionDoc)&#xd;
   #set($asDoc = $analysisSessionDoc)&#xd;
   #set($riskEvaluation = $asDoc.getObject('RISCOSSPlatformRiskAnalysisManagerCode.RiskEvaluationClass'))&#xd;
   #if ($riskEvaluation.getProperty('result').value != '')&#xd;
      #set($analysisResults = $jsontool.parse($riskEvaluation.getProperty('result').getValue()))&#xd;
      #set($projectScore = 1)&#xd;
      #foreach($result in $analysisResults)&#xd;
         #set($resultScore = $result.value.positive)&#xd;
         #set($projectScore = $mathtool.mul($projectScore,$resultScore))&#xd;
      #end&#xd;
      #set($projectScore = $mathtool.roundTo(4,$projectScore))&#xd;
   #else&#xd;
      #set($projectScore = 0)&#xd;
   #end&#xd;
#end   &#xd;
&#xd;
## Calculate the top ten analysis average score&#xd;
#macro(calculateTopTenProjectsAverageScore)&#xd;
   #set($query = "from doc.object(RISCOSSPlatformRiskAnalysisManagerCode.RiskEvaluationClass) as session")&#xd;
   #set($riskAnlysisSessions = $services.query.xwql($query).execute())&#xd;
   #set($projectsScores = [])&#xd;
   #foreach($riskAnalysis in $riskAnlysisSessions)&#xd;
      #set($raDoc = $xwiki.getDocument($riskAnalysis))&#xd;
      #set($riskEvaluation = $raDoc.getObject('RISCOSSPlatformRiskAnalysisManagerCode.RiskEvaluationClass'))&#xd;
      #if ($riskEvaluation.getProperty('result').value != '')&#xd;
         #set($analysisResults = $jsontool.parse($riskEvaluation.getProperty('result').getValue()))&#xd;
         #set($score = 1)&#xd;
         #foreach($result in $analysisResults)&#xd;
            #set($resultScore = $result.value.positive)&#xd;
            #set($score = $mathtool.mul($score,$resultScore))&#xd;
         #end&#xd;
         #set($score = $mathtool.roundTo(4,$score))&#xd;
         #set($discard = $projectsScores.add($score))&#xd;
      #end&#xd;
   #end   &#xd;
   ## Sort projects scores&#xd;
   #set($projectsScores = $sorttool.sort($projectsScores))&#xd;
   #set($topTenProjectsScores = $projectsScores)&#xd;
   #if($projectsScores.size() > 10)&#xd;
      #set($topTenProjectsScores = $projectsScores.subList($mathtool.sub($projectsScores.size(),10), $projectsScores.size()))&#xd;
   #end&#xd;
   ## Calculate the average top ten score&#xd;
   #set($topTenProjectsScoresAverage = $mathtool.getAverage($topTenProjectsScores))&#xd;
#end     &#xd;
{{/velocity}}</content>
</xwikidoc>