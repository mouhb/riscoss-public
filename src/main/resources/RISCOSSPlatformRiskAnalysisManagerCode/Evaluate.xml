<?xml version='1.0' encoding='UTF-8'?>
<xwikidoc version="1.1">
  <web>RISCOSSPlatformRiskAnalysisManagerCode</web>
  <name>Evaluate</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1430839815000</creationDate>
  <parent>RISCOSSPlatformRiskAnalysisManagerCode.WebHome</parent>
  <author>xwiki:XWiki.superadmin</author>
  <contentAuthor>xwiki:XWiki.superadmin</contentAuthor>
  <date>1438180894000</date>
  <contentUpdateDate>1438180889000</contentUpdateDate>
  <version>1.98</version>
  <title>Evaluate '$request.entity'</title>
  <comment>Imported from XAR</comment>
  <minorEdit>true</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity}}&#xd;
## -*- Mode: Velocity&#xd;
##&#xd;
#set($EVAL_GROOVY_PG = "RISCOSSPlatformRiskAnalysisManagerCode.EvaluateGroovy")&#xd;
#set ($analyserAPI = $xwiki.parseGroovyFromPage($EVAL_GROOVY_PG))&#xd;
##&#xd;
#set($ok = false)&#xd;
#set($riskAnalysisSession = $request.getParameter('riskAnalysisSession'))&#xd;
#if (!$riskAnalysisSession)&#xd;
  #if("$!request.getParameter('entity')" == "")&#xd;
    {{error}}Missing "entity" parameter{{/error}}&#xd;
  #elseif("$!request.getParameter('riskConfiguration')" == "")&#xd;
    {{error}}Missing "riskConfiguration" parameter{{/error}}&#xd;
  #else&#xd;
    #set($sessionDoc = $analyserAPI.getSessionDoc($xwiki,&#xd;
                                                  $request.getParameter('entity'),&#xd;
                                                  $request.getParameter('riskConfiguration'),&#xd;
                                                  true))&#xd;
    #if("$!sessionDoc" == "ERROR_riskConfig_nonexistant")&#xd;
      {{error}}Parameter "riskConfiguration" points to nonexistant document{{/error}}&#xd;
    #elseif("$!sessionDoc" == "ERROR_targetName_nonexistant")&#xd;
      {{error}}Parameter "entity" points to nonexistant document{{/error}}&#xd;
    #else&#xd;
      #set($riskAnalysisSession = $sessionDoc.getFullName())&#xd;
      #set($ok = true)&#xd;
    #end&#xd;
  #end&#xd;
#else&#xd;
  #set($sessionDoc = $xwiki.getDocument($riskAnalysisSession))&#xd;
  #if($sessionDoc.isNew())&#xd;
    {{error}}Parameter "riskAnalysisSession" points to nonexistant document{{/error}}&#xd;
  #else&#xd;
    #set($ok = true)&#xd;
  #end&#xd;
#end&#xd;
##&#xd;
#if($ok == true)&#xd;
  #set($inputs = $analyserAPI.getInputs($xcontext, $sessionDoc))&#xd;
  #if ($inputs.getString("ret") != "0" || "$!inputs.optJSONObject('output')" == "")&#xd;
    #set($ok = false)&#xd;
    {{error}}&#xd;
      Failed to get input values&#xd;
      RETCODE: $inputs.getString("ret")&#xd;
&#xd;
      STDOUT:&#xd;
&#xd;
      {{code language=none}}&#xd;
        $inputs.getString("stdout")&#xd;
      {{/code}}&#xd;
&#xd;
      STDERR:&#xd;
&#xd;
      {{code language=none}}&#xd;
        $inputs.getString("stderr")&#xd;
      {{/code}}&#xd;
&#xd;
    {{/error}}&#xd;
  #end&#xd;
#end&#xd;
##&#xd;
#if($ok == true)&#xd;
  #set($entityDoc = $xwiki.getDocument($analyserAPI.targetForSession($sessionDoc)))&#xd;
  #set($riskData =&#xd;
    $analyserAPI.getRiskData($services, $inputs, $analyserAPI.getRDRPath($xwiki), $entityDoc.name))&#xd;
    ##set($errout = $riskData.getJSONArray("errors"))&#xd;
    ## Code modified by mohamed to fix the issue, need to Caleb's check.&#xd;
    #if($riskData.has("output"))&#xd;
       #set($errout = $riskData.getJSONObject("output").getJSONArray("errors"))&#xd;
    #else&#xd;
       #set($errout = $riskData.getJSONArray("errors"))&#xd;
    #end&#xd;
    #if($errout.length() > 0)&#xd;
    #set($ok = false)&#xd;
    {{error}}&#xd;
      Failed to data from RDR&#xd;
      #foreach($err in $errout)&#xd;
&#xd;
        {{code language=none}}$err{{/code}}&#xd;
&#xd;
      #end&#xd;
    {{/error}}&#xd;
  #end&#xd;
#end&#xd;
##&#xd;
#if($ok == true)&#xd;
  #set($interpretedRiskData = $analyserAPI.interpret($xcontext, $sessionDoc, $riskData))&#xd;
  #set($output = "")&#xd;
  #set($output = $interpretedRiskData.optJSONObject("output"))&#xd;
  #if("$!output" == "")&#xd;
    #set($ok = false)&#xd;
    {{error}}&#xd;
      Failed to interpret risk data&#xd;
      COMMAND: $interpretedRiskData.getString("command")&#xd;
&#xd;
      RETCODE: $interpretedRiskData.getString("ret")&#xd;
      STDOUT:&#xd;
&#xd;
      {{code language=none}}&#xd;
        $interpretedRiskData.getString("stdout")&#xd;
      {{/code}}&#xd;
&#xd;
      STDERR:&#xd;
&#xd;
      {{code language=none}}&#xd;
        $interpretedRiskData.getString("stderr")&#xd;
      {{/code}}&#xd;
&#xd;
      INPUT:&#xd;
&#xd;
      {{code language=none}}&#xd;
        $riskData.toString(2)&#xd;
      {{/code}}&#xd;
&#xd;
    {{/error}}&#xd;
  #end&#xd;
#end&#xd;
##&#xd;
#if($ok == true)&#xd;
  #set($outRaw = $analyserAPI.evaluate($xcontext, $sessionDoc, $interpretedRiskData))&#xd;
  #set($output = $outRaw.optJSONObject("output"))&#xd;
  #set($result = "")&#xd;
  #if($output)&#xd;
    #set($result = $output.optJSONObject("result"))&#xd;
  #end&#xd;
  #if("$!result" == "")&#xd;
    #set($ok = false)&#xd;
    {{error}}&#xd;
      Failed to run evaluation&#xd;
      COMMAND: $outRaw.getString("command")&#xd;
&#xd;
      RETCODE: $outRaw.getString("ret")&#xd;
      STDOUT:&#xd;
&#xd;
      {{code language=none}}&#xd;
        $outRaw.getString("stdout")&#xd;
      {{/code}}&#xd;
&#xd;
      STDERR:&#xd;
&#xd;
      {{code language=none}}&#xd;
        $outRaw.getString("stderr")&#xd;
      {{/code}}&#xd;
&#xd;
      INPUT:&#xd;
&#xd;
      {{code language=none}}&#xd;
        $interpretedRiskData.toString(2)&#xd;
      {{/code}}&#xd;
&#xd;
    {{/error}}&#xd;
  #end&#xd;
#end&#xd;
##&#xd;
#if($ok == true)&#xd;
  $analyserAPI.storeResults($sessionDoc, $result, $riskData, $outRaw, $interpretedRiskData, 0)##&#xd;
  #if ("$!request.getProperty('xredirect')" != "")&#xd;
    $response.sendRedirect($request.getProperty('xredirect'))&#xd;
  #else&#xd;
    $response.sendRedirect($sessionDoc.getURL())&#xd;
  #end&#xd;
#end&#xd;
{{/velocity}}&#xd;
</content>
</xwikidoc>