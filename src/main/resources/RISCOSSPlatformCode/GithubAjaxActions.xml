<?xml version='1.0' encoding='UTF-8'?>
<xwikidoc version="1.1">
  <web>RISCOSSPlatformCode</web>
  <name>GithubAjaxActions</name>
  <language/>
  <defaultLanguage>en</defaultLanguage>
  <translation>0</translation>
  <creator>xwiki:XWiki.superadmin</creator>
  <creationDate>1435580009000</creationDate>
  <author>xwiki:XWiki.superadmin</author>
  <contentAuthor>xwiki:XWiki.superadmin</contentAuthor>
  <date>1443601929000</date>
  <contentUpdateDate>1443529476000</contentUpdateDate>
  <version>1.565</version>
  <title/>
  <comment/>
  <minorEdit>true</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity}}&#xd;
## This page receives ajax request related to the management of github projects&#xd;
&#xd;
## Globals&#xd;
#set($API = $xwiki.parseGroovyFromPage("RISCOSSPlatformCode.CreateFromGithubGroovy"))&#xd;
## Get RISCOSS platform configuration information&#xd;
#set($confDoc = $xwiki.getDocument("RISCOSSPlatformCode.RISCOSSConfiguration"))&#xd;
#set($superConf = $confDoc.getObject("RISCOSSPlatformCode.RISCOSSConfiguration"))&#xd;
#set($clientID = $superConf.getProperty("githubAppClientID").getValue())&#xd;
#set($clientSecret = $superConf.getProperty("githubAppClientSecret").getValue())&#xd;
##&#xd;
&#xd;
#set($action = $request.action)&#xd;
#if ("$!action" != '')&#xd;
## Enable/Disable analysis&#xd;
   #if ($action == 'enableDisableAnalysis')&#xd;
      #set($githubRepo = $request.githubRepo)&#xd;
      #set($entity = "") &#xd;
      #set($status = $request.status)&#xd;
      #if ($status == "enable")&#xd;
         #set($entityCreationStatus = false)&#xd;
         #if ($API.isOkGithubURL($githubRepo))&#xd;
            #set($userName = $xwiki.getDocument($xcontext.user).name)&#xd;
            #set($entityDocFullName = $API.docNameForGithubURL($githubRepo, $userName))&#xd;
            ## Manage projects that contains dots in the name&#xd;
            #set($entitySpace = "RISCOSSPlatformEntities${userName}.")&#xd;
            #set($entityDocFullName = $escapetool.url($entityDocFullName).replace("%5C",""))&#xd;
            #set($entityDocName = $entityDocFullName.substring($entitySpace.length()))&#xd;
            #set($entityDocName = $entityDocName.replace(".","\."))&#xd;
            #set($entityDocFullName = $entitySpace + $entityDocName)&#xd;
            ##&#xd;
            #set($entityDoc = $xwiki.getDocument($entityDocFullName))&#xd;
            #if ($entityDoc.isNew())&#xd;
               #set($title = $escapetool.url($API.titleForGithubURL($githubRepo)))&#xd;
               #set($parent = "${entityDoc.getSpace()}.WebHome")&#xd;
               #set($discard = $entityDoc.setTitle($title))&#xd;
               #set($discard = $entityDoc.setParent($parent))&#xd;
               #set($entityObj = $entityDoc.newObject("RISCOSSPlatformLayerManagerCode.EntityClass"))&#xd;
               #set($discard = $entityObj.set("layer","RISCOSSPlatformLayers.OSSComponent"))&#xd;
               #set($osscObj = $entityDoc.newObject("RISCOSSPlatformLayers.OSSComponent"))&#xd;
               #set($discard = $osscObj.set("name",$title))&#xd;
               #set($discard = $osscObj.set("website",$githubRepo))&#xd;
               #if("$!request.description" != '')&#xd;
                  #set($discard = $osscObj.set("description",$request.description))&#xd;
               #end&#xd;
               #set($discard = $entityDoc.save())&#xd;
               #set($entityCreationStatus = true)&#xd;
               #set($entity = $escapetool.url($entityDocFullName).replace("%5C",""))&#xd;
            #end&#xd;
         #end&#xd;
         {"entityCreationStatus": $entityCreationStatus, "entity": "$entity"}&#xd;
      #elseif ($status == "disable")&#xd;
         #if ($API.isOkGithubURL($githubRepo))&#xd;
            ## Manage projects that contains dots in the name&#xd;
            #set($userName = $xwiki.getDocument($xcontext.user).name)&#xd;
            #set($entityDocFullName = $API.docNameForGithubURL($githubRepo, $userName))&#xd;
            #set($entitySpace = "RISCOSSPlatformEntities${userName}.")&#xd;
            #set($entityDocFullName = $escapetool.url($entityDocFullName).replace("%5C",""))&#xd;
            #set($entityDocName = $entityDocFullName.substring($entitySpace.length()))&#xd;
            #set($entityDocName = $entityDocName.replace(".","\."))&#xd;
            #set($entityDocFullName = $entitySpace + $entityDocName)&#xd;
            ##&#xd;
            #if($xwiki.exists($entityDocFullName))&#xd;
               #set($entityDoc = $xwiki.getDocument($entityDocFullName))&#xd;
               #set($discard = $entityDoc.delete())&#xd;
            #end&#xd;
            #set($query = "from doc.object(RISCOSSPlatformRiskAnalysisManagerCode.RiskEvaluationClass) as session where session.entity='${entityDocFullName}' and session.riskConfiguration='RISCOSSPlatformRiskConfigurations.BasicRiskConfiguration' and doc.space='RISCOSSPlatformRiskAnalysisSessions${userName}'")&#xd;
            #set($riskAnlysisSessions = $services.query.xwql($query).execute())&#xd;
            ## Delete sessions&#xd;
            #foreach($session in $riskAnlysisSessions)&#xd;
               #set($discard = $xwiki.getDocument($session).delete())&#xd;
            #end&#xd;
            {"analysisStatusDisabling": true}&#xd;
         #end &#xd;
      #end&#xd;
   #elseif($action == "runDataCollector")&#xd;
      #if("$!request.entity" != '')&#xd;
         #set($userName = $xwiki.getDocument($xcontext.user).name)&#xd;
         ## Manage projects that contains dots in the name&#xd;
         #set($entitySpace = "RISCOSSPlatformEntities${userName}.")&#xd;
         #set($entityDocFullName = $escapetool.url($request.entity).replace("%5C",""))&#xd;
         #set($entityDocName = $entityDocFullName.substring($entitySpace.length()))&#xd;
         #set($entityDocName = $entityDocName.replace(".","\."))&#xd;
         #set($entityDocFullName = $entitySpace + $entityDocName)&#xd;
         #if($xwiki.exists($entityDocFullName))&#xd;
            #set($dataCollector = $xwiki.parseGroovyFromPage("RISCOSSPlatformDataCollectorCode.DataCollectorGroovy"))&#xd;
            #set($discard = $dataCollector.runDataCollectorOnDemand($xcontext, $services, $xwiki, $entityDocFullName))&#xd;
            $entityDocFullName&#xd;
         #end&#xd;
      #end&#xd;
   #elseif($action == "displayProjectResultsCharts")&#xd;
      #if("$request.data" != '')&#xd;
         #set($analysisResults = $jsontool.parse($request.data))&#xd;
         #set($riskLabels = ["Obsolescence Risk","Bug Risk","Analysability Risk","Maintenance Risk"])&#xd;
         #set($cols = "|=")&#xd;
         #set($values = "|")&#xd;
         #foreach($rlabel in $riskLabels)&#xd;
            #set($cols = "${cols}|=${rlabel}")&#xd;
            #set($result = $analysisResults[$rlabel])&#xd;
            #set($values = "${values}|${result.value.positive}")&#xd;
         #end&#xd;
         {{chart type="bar" source="inline" params="range:B2-E2;series:columns;" title="Risk analysis results" width="500" height="300"}}&#xd;
         $cols&#xd;
         $values&#xd;
         {{/chart}}         &#xd;
      #end&#xd;
    #elseif($action == "checkProjectExists")&#xd;
       #set($projectExists = 1) ## The project already exists int the projects list of the connected user&#xd;
       #if("$!request.githubRepo" != '')&#xd;
          #set($githubRepo = $request.githubRepo)&#xd;
          #set($userName = $xwiki.getDocument($context.user).name)&#xd;
          #set($githubProjectURLs = [])&#xd;
          #if($userName.startsWith("github_"))&#xd;
             #set($githubUser = $userName.replace("github_", ""))&#xd;
             #set($sourceURL = "https://api.github.com/users/${githubUser}/repos?client_id=${clientID}&amp;client_secret=${clientSecret}")&#xd;
             #set($jsonResp = $xwiki.getURLContent($sourceURL))&#xd;
             ## Connected user github projects&#xd;
             #set($gitHubProjects = $jsontool.parse($jsonResp))&#xd;
             ## Get projects created by the user but not in his github projects list&#xd;
             #foreach($p in $gitHubProjects)&#xd;
                #set($discard = $githubProjectURLs.add($p.clone_url))&#xd;
             #end&#xd;
          #end&#xd;
          #set($xwql = "SELECT DISTINCT layer.website, doc.fullName FROM Document doc, " +&#xd;
          "doc.object(RISCOSSPlatformLayerManagerCode.EntityClass) AS entity, doc.object(RISCOSSPlatformLayers.OSSComponent) AS layer WHERE" + &#xd;
          " doc.space like 'RISCOSSPlatformEntities%' and doc.space&lt;&gt;'RISCOSSPlatformEntities' and layer.website='$githubRepo' and entity.layer='RISCOSSPlatformLayers.OSSComponent'")&#xd;
          #set($results = $services.query.xwql($xwql).setLimit(5).execute())&#xd;
          #if($results.size() == 0 &amp;&amp; !$githubProjectURLs.contains($githubRepo))&#xd;
             #set($projectExists = -1)&#xd;
          #else&#xd;
             #if($results.size() > 0)&#xd;
                #set($entityDocRef = $results[0][1])&#xd;
                #if($xwiki.exists($entityDocRef) &amp;&amp; $xwiki.getDocument($entityDocRef).getAuthor() != $xcontext.user)&#xd;
                   #set($projectExists = 2) ## The project was already analysed by another user &#xd;
                #end&#xd;
             #end&#xd;
          #end&#xd;
       #end&#xd;
       {"projectExists": $projectExists}&#xd;
    #end&#xd;
#end&#xd;
{{/velocity}}</content>
</xwikidoc>