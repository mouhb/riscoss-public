<?xml version='1.0' encoding='UTF-8'?>
<xwikidoc version="1.1">
  <web>RISCOSSPlatformCode</web>
  <name>GitHubLiveTableResults</name>
  <language/>
  <defaultLanguage>en</defaultLanguage>
  <translation>0</translation>
  <creator>xwiki:XWiki.superadmin</creator>
  <creationDate>1435330604000</creationDate>
  <author>xwiki:XWiki.superadmin</author>
  <contentAuthor>xwiki:XWiki.superadmin</contentAuthor>
  <date>1443535798000</date>
  <contentUpdateDate>1443535781000</contentUpdateDate>
  <version>1.544</version>
  <title/>
  <comment/>
  <minorEdit>true</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity wiki="false"}}&#xd;
## -*- Mode:Velocity&#xd;
## Output fields:&#xd;
##   project&#xd;
##   enabledisable&#xd;
##   analysstatus&#xd;
## Filterable fields:&#xd;
##   &#xd;
##   &#xd;
## Orderable fields:&#xd;
##   &#xd;
##   &#xd;
&#xd;
## Globals&#xd;
#set($API = $xwiki.parseGroovyFromPage("RISCOSSPlatformCode.CreateFromGithubGroovy"))&#xd;
##&#xd;
&#xd;
#set($offset = $mathtool.toInteger($request.get('offset')))&#xd;
## offset starts from 0 in velocity and 1 in javascript&#xd;
#set($offset = $offset - 1)&#xd;
#if (!$offset || $offset &lt; 0)##>## syntax highligher bug&#xd;
  #set($offset = 0)&#xd;
#end&#xd;
#set($limit = $mathtool.toInteger($request.get('limit')))&#xd;
#if (!$limit)&#xd;
  #set ($limit = 15)&#xd;
#end&#xd;
&#xd;
## List github projects&#xd;
#set($userName = $xwiki.getDocument($context.user).name)&#xd;
#set($githubUser = $userName.replace("github_", ""))&#xd;
&#xd;
## Increasing the unauthenticated rate limit for OAuth applications&#xd;
## If your OAuth application needs to make unauthenticated calls with a higher rate limit, &#xd;
## you can pass your appâ€™s client ID and secret as part of the query string.&#xd;
## As mentionned here : https://developer.github.com/v3/#rate-limiting&#xd;
## Get RISCOSS platform configuration information&#xd;
#set($confDoc = $xwiki.getDocument("RISCOSSPlatformCode.RISCOSSConfiguration"))&#xd;
#set($superConf = $confDoc.getObject("RISCOSSPlatformCode.RISCOSSConfiguration"))&#xd;
#set($clientID = $superConf.getProperty("githubAppClientID").getValue())&#xd;
#set($clientSecret = $superConf.getProperty("githubAppClientSecret").getValue())&#xd;
#set($sourceURL = "https://api.github.com/users/${githubUser}/repos?client_id=${clientID}&amp;client_secret=${clientSecret}")&#xd;
&#xd;
#if($userName.startsWith("github_"))&#xd;
   #set($jsonResp = $xwiki.getURLContent($sourceURL))&#xd;
   ## Connected user github projects&#xd;
   #set($gitHubProjects = $jsontool.parse($jsonResp))&#xd;
#else&#xd;
   #set($gitHubProjects = [])&#xd;
#end&#xd;
&#xd;
## Get projects created by the user but not in his github projects list&#xd;
#set($githubProjectURLs = [])&#xd;
&#xd;
#if("$!gitHubProjects.message" != '' and $gitHubProjects.message == "Not Found")&#xd;
   #set($gitHubProjects = [])&#xd;
#else&#xd;
#foreach($p in $gitHubProjects)&#xd;
   #set($discard = $githubProjectURLs.add($p.clone_url))&#xd;
#end&#xd;
#end&#xd;
&#xd;
#if($githubProjectURLs.size() == 0)&#xd;
   #set($githubProjectURLs = [""])&#xd;
#end&#xd;
&#xd;
#set($xwql = "SELECT DISTINCT layer.website, layer.name, layer.description FROM Document doc, " +&#xd;
    "doc.object(RISCOSSPlatformLayerManagerCode.EntityClass) AS entity, doc.object(RISCOSSPlatformLayers.OSSComponent) AS layer" + &#xd;
    " WHERE " +&#xd;
    " doc.space='RISCOSSPlatformEntities${userName}' and doc.author='$xcontext.user' and layer.website NOT IN (:githubProjectURLs) and entity.layer='RISCOSSPlatformLayers.OSSComponent'")&#xd;
#set($results = $services.query.xwql($xwql).bindValue("githubProjectURLs", $githubProjectURLs).execute())&#xd;
#set($otherGithubProjects = [])&#xd;
#foreach($p in $results)&#xd;
   #set($v = {"clone_url": $p[0], "name": $p[1], "description": $p[2], "id": "id"})&#xd;
   #set($discard = $otherGithubProjects.add($v))   &#xd;
#end&#xd;
&#xd;
#if($gitHubProjects.size() == 0)&#xd;
   #set($gitHubProjects = $otherGithubProjects)&#xd;
#else&#xd;
   #set($discard = $gitHubProjects.addAll($otherGithubProjects))&#xd;
#end&#xd;
&#xd;
#set($totalrows = $gitHubProjects.size())&#xd;
&#xd;
## Build the result JSON&#xd;
#set($resultMap = {})&#xd;
#set($discard = $resultMap.put("totalrows", $totalrows))&#xd;
#set($returnedProjects = [])&#xd;
#if($limit >= 0)&#xd;
   #set($returnedProjects = $gitHubProjects.subList($offset, $mathtool.min($mathtool.add($offset, $limit),$totalrows)))&#xd;
#end&#xd;
#set($discard = $resultMap.put("returnedrows", $returnedProjects.size()))&#xd;
#set($discard = $resultMap.put("offset", $mathtool.add($offset, 1)))&#xd;
#set($discard = $resultMap.put("reqNo", $util.parseInt($request.reqNo)))&#xd;
#set($rows = [])&#xd;
#foreach($project in $returnedProjects)&#xd;
  #set($row = {})&#xd;
  #set($discard = $row.put("doc_viewable", true))&#xd;
  #set($entityDocRef = $API.docNameForGithubURL($project.clone_url, $userName))&#xd;
  ## Manage projects that contains dots in the name&#xd;
  #set($entitySpace = "RISCOSSPlatformEntities${userName}.")&#xd;
  #set($entityDocRef = $escapetool.url($entityDocRef).replace("%5C",""))&#xd;
  #set($entityDocName = $entityDocRef.substring($entitySpace.length())) ## (24 == $entitySpace.length)&#xd;
  #set($entityDocName = $entityDocName.replace(".","\."))&#xd;
  #set($entityDocRef = $entitySpace + $entityDocName)&#xd;
  ##&#xd;
  #set($enabled = $xwiki.exists($entityDocRef))&#xd;
  #if($enabled)&#xd;
     #set($projectPageURL = $xwiki.getURL("RISCOSSPlatformCode.ProjectPage", "view", "project=${escapetool.url($entityDocRef)}"))&#xd;
     #set($discard = $row.put("project", "&lt;a href='$projectPageURL' class='projectLink'>${project.name}&lt;/a>"))&#xd;
  #else&#xd;
     #set($discard = $row.put("project", "$project.name"))&#xd;
  #end&#xd;
    &#xd;
  ## Get associated sessions&#xd;
  #set($query = "from doc.object(RISCOSSPlatformRiskAnalysisManagerCode.RiskEvaluationClass) as session where session.entity='${entityDocRef}' and session.riskConfiguration='RISCOSSPlatformRiskConfigurations.BasicRiskConfiguration' and doc.space='RISCOSSPlatformRiskAnalysisSessions${userName}'")&#xd;
  #set($riskAnlysisSessions = $services.query.xwql($query).setLimit(1).execute())&#xd;
  #set($checked = '')&#xd;
  #set($analysisStatus = "Disabled")&#xd;
  #set($alreadyEvaluated = false)&#xd;
  #if($enabled &amp;&amp; $riskAnlysisSessions.size() > 0)&#xd;
     #set($checked = 'checked="checked"')&#xd;
     #set($riskEvaluationDocRef = $riskAnlysisSessions[0])&#xd;
     #set($riskEvaluationDoc = $xwiki.getDocument($riskEvaluationDocRef))&#xd;
     #set($riskEvaluationObj = $riskEvaluationDoc.getObject("RISCOSSPlatformRiskAnalysisManagerCode.RiskEvaluationClass"))&#xd;
     #if("$!riskEvaluationObj" != '')&#xd;
        #set($alreadyEvaluated = true)&#xd;
        #if("$!riskEvaluationObj.getProperty('timeLastRun').getValue()" != '')&#xd;
           #set($evaluationTimeLastRun =  $xwiki.getDate($riskEvaluationObj.getProperty('timeLastRun').getValue()))&#xd;
        #end&#xd;
        #set($analysisStatus = "Last evaluation : $!evaluationTimeLastRun")&#xd;
     #end&#xd;
  #end&#xd;
  #set($description = $escapetool.xml($project.description))&#xd;
  #set($projectDescription = "&lt;input id='projectDescription${project.id}' value='${description}' style='display:none;'/>")&#xd;
  #set($discard = $row.put("enabledisable", "&lt;input type='checkbox' class='enabdisabchk' value='${project.clone_url}|${project.id}' $checked/>${projectDescription}"))&#xd;
  #set($discard = $row.put("analysisstatus", "&lt;div class='analysistatus' id='analysisstatus${project.id}'>${analysisStatus}&lt;/div>"))&#xd;
  #if($alreadyEvaluated)&#xd;
     #set($discard = $row.put("reevaluate","&lt;a href='javascript:;' class='reevaluateBtn' title='Re-evaluate' rel='${project.clone_url}|${entityDocRef}|${project.id}'>&lt;/a>"))&#xd;
  #else&#xd;
     #set($discard = $row.put("reevaluate","---"))&#xd;
  #end&#xd;
 &#xd;
  #set($discard = $rows.add($row))&#xd;
#end&#xd;
#set($discard = $resultMap.put("rows", $rows))&#xd;
&#xd;
$jsontool.serialize($resultMap)&#xd;
&#xd;
{{/velocity}}</content>
</xwikidoc>